<html lang="en">

<head>
    <title>Jira &amp; Bitrise: Updating Tickets with New Builds - James O'Brien</title>
    <link rel="canonical" href="https://medium.com/@jimmithy/jira-bitrise-updating-tickets-with-new-builds-583861f7a5d5" />
    <meta name="description" content="How to get Bitrise to post a comment in a Jira ticket when a build has completed." />
    <link rel="icon" type="image/png" sizes="32x32" href="../fav/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="../fav/favicon-16x16.png" />
    <link rel="manifest" href="../fav/site.webmanifest">
    <link rel="stylesheet" type="text/css" href="../style.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto&display=swap">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="utf-8" />
    <meta name="theme-color" content="#222222" />
    <script>
    (function(i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function() {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date();
        a = s.createElement(o),
            m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m)
    })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

    ga('create', 'UA-70691048-2', 'auto');
    ga('send', 'pageview');
    </script>
    <style>
        .article {
            max-width: 680px;
            margin: 0 auto;
            padding: 20px;
        }
        .article h1 {
            font-size: 36px;
            margin-bottom: 10px;
            text-transform: none;
            letter-spacing: 0;
        }
        .article-meta {
            color: #888;
            font-size: 14px;
            margin-bottom: 30px;
        }
        .article p {
            font-size: 18px;
            line-height: 1.7;
            margin-bottom: 24px;
            color: #333;
        }
        .article h2 {
            font-size: 28px;
            margin: 36px 0 16px;
            text-transform: none;
            letter-spacing: 0;
        }
        .article h3 {
            font-size: 22px;
            margin: 30px 0 12px;
            text-transform: none;
            letter-spacing: 0;
        }
        .article h4 {
            font-size: 18px;
            margin: 28px 0 10px;
            text-transform: none;
            letter-spacing: 0;
        }
        .article ul, .article ol {
            font-size: 18px;
            line-height: 1.7;
            margin-bottom: 24px;
            padding-left: 28px;
            color: #333;
        }
        .article li {
            margin-bottom: 8px;
        }
        .article pre {
            background: #f4f4f4;
            border-left: 3px solid #444444;
            padding: 16px;
            overflow-x: auto;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 24px;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .article code {
            background: #f4f4f4;
            padding: 2px 5px;
            font-size: 15px;
            border-radius: 3px;
            font-family: monospace;
        }
        .article pre code {
            background: none;
            padding: 0;
            font-size: 14px;
        }
        .article figure {
            margin: 0 0 24px;
        }
        .article figure img {
            max-width: 100%;
            height: auto;
            display: block;
            border: 1px solid rgba(0,0,0,.1);
        }
        .article figcaption {
            font-size: 14px;
            color: #888;
            margin-top: 8px;
            text-align: center;
        }
        .article .further-reading {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #dddddd;
        }
        .article .further-reading h4 {
            margin-bottom: 12px;
        }
        .article .further-reading ul {
            font-size: 16px;
        }
        .article-source {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #dddddd;
            font-size: 14px;
            color: #888;
        }
        @media (prefers-color-scheme: dark) {
            .article p,
            .article ul,
            .article ol {
                color: #d0d0d0;
            }
            .article pre {
                background: #2a2a2a;
                border-left-color: #666666;
            }
            .article code {
                background: #2a2a2a;
                color: #d0d0d0;
            }
            .article figure img {
                border-color: rgba(255, 255, 255, 0.1);
            }
            .article figcaption,
            .article-meta {
                color: #aaaaaa;
            }
            .article .further-reading,
            .article-source {
                border-top-color: #333333;
                color: #aaaaaa;
            }
        }
    </style>
</head>

<body>
    <section id="header">
        <div id="headerCenter">
            <a href="../index.html"><img id="avatar" src="../img/avatar.png"/></a>
            <a href="../index.html" id="title">James O'Brien</a>
            <ul class="navigation">
                <li><a href="../index.html">Home</a></li>
                <li><a href="../apps">Applications</a></li>
                <li><a href="../writings.html">Writings</a></li>
            </ul>
            <div class="social">
                <a href="https://www.linkedin.com/in/jimmithy/" target="_blank" title="linkedin">
                    <svg class="icons" width="20" height="20" viewBox="0 0 1000 1000">
                        <path d="M892,10H108c-53.9,0-98,44.1-98,98v784c0,53.9,44.1,98,98,98h784c53.9,0,98-44.1,98-98V108C990,54.1,945.9,10,892,10z M304,843H157V402h147V843z M230.5,318.7c-49,0-88.2-39.2-88.2-88.2c0-49,39.2-88.2,88.2-88.2c49,0,88.2,39.2,88.2,88.2C318.7,279.5,279.5,318.7,230.5,318.7z M843,843H696V583.3c0-39.2-34.3-73.5-73.5-73.5c-39.2,0-73.5,34.3-73.5,73.5V843H402V402h147v58.8c24.5-39.2,78.4-68.6,122.5-68.6c93.1,0,171.5,78.4,171.5,171.5V843z"></path>
                    </svg>
                </a>
            </div>
        </div>
    </section>
    <section id="content">
        <article class="article">
            <h1>Jira &amp; Bitrise: Updating Tickets with New Builds</h1>
            <p class="article-meta">June 26, 2020</p>

            <p>I joined a team this year which has been experimenting with using <a href="http://bitrise.io" target="_blank">Bitrise</a> for <a href="https://en.wikipedia.org/wiki/Continuous_integration" target="_blank">Continuous Integration</a> of Android and iOS builds. I come from a Jenkins background, so it was a great opportunity to learn something new and overall I have been impressed by Bitrise's simple to understand workflow with almost drag and drop components.</p>
            <p>The problems I found was that the team members not working in engineering would often ask the developer for a link to the Bitrise build so they could download and test. The Bitrise job would output multiple files, so there were often questions over which build to use. We were also using the github plugin in Jira, but it was cumbersome to navigate through Jira, github, Bitrise to locate the latest build.</p>
            <p>In an attempt to improve this process, I decided to write an addition to our Bitrise workflow which would post a comment on the Jira ticket once the build had completed.</p>

            <h3>Find Jira Tickets Script</h3>
            <p>The first problem I needed to solve was to figure out the relationship between Bitrise builds and Jira tickets. My workplace typically require that the Jira ticket is included in the commit message and/or the branch name. Fortunately, Bitrise provide these as environment variables which I can then search for the ticket number.</p>
            <p>I visited the workflow editor, selected my primary workflow, and added a new step at the end. I was unable to find an existing step that would identify Jira tickets, so I selected the <em>Script</em> step which would let me run my custom bash query.</p>
            <figure>
                <img src="img/1_Jqj-d7DLAO8XQAT7zUPEcg.png" alt="Bitrise workflow editor showing Find Jira Issue step" />
                <figcaption>I named it 'Find Jira Issue' so it could be easily identified in the workflow</figcaption>
            </figure>

            <h4>Update</h4>
            <p>I submitted this step to Bitrise to include in their catalog of steps, so you can now just select the Find Jira Issue step instead of selecting Script. The step will allow you to set the input and will output a list of unique tickets as <em>$JIRA_ISSUE_LIST</em>.</p>
            <p><a href="https://www.bitrise.io/integrations/steps/find-jira-issue" target="_blank">https://www.bitrise.io/integrations/steps/find-jira-issue</a></p>

            <h4>Searching the commit message for a ticket</h4>
            <pre><code>#!/usr/bin/env bash
set -o pipefail

echo "Extracting JIRA Issue number from commit message '${BITRISE_GIT_MESSAGE}"

JIRA_ISSUE="$(echo "${BITRISE_GIT_MESSAGE}" | egrep -o '[a-zA-Z]+-[0-9]+' | sort -uf | tr '\n' '|' | sed 's/.$//'")</code></pre>

            <h4>Breaking down the query</h4>
            <p>The first step is to select the input. This can be different depending on your process. Some teams use the branch name to identify the ticket, others will add it to the commit message. Bitrise provides environment variables to identify each of these inputs so these can be used in your workflow step. Here is an example of using both the commit message and branch name as the input:</p>
            <pre><code>echo "${BITRISE_GIT_MESSAGE} ${BITRISE_GIT_BRANCH}"</code></pre>
            <p>Next we search for anything that matches a Jira ticket pattern, this is typically as follows:<br>
             1. Upper or lower case text which will identify a Jira Project<br>
             2. Separated by a hyphen<br>
             3. Ends in a number, which will indicate the ticket id</p>
            <pre><code>egrep -o '[a-zA-Z]+-[0-9]+'</code></pre>
            <p>You could add character limits to both the Jira project and ticket number to enforce a specific pattern and reduce false matches, or if you use a single Jira project you can be specific about the name.</p>
            <pre><code>egrep -o 'PROJECT-[0-9]+'</code></pre>
            <p>To ensure we find unique tickets, you can sort this list with flags specifying that the sorting is case insensitive and the output should remove any duplicates.</p>
            <pre><code>sort -uf</code></pre>
            <p>The search request will output each successful result on new lines and to make this Bitrise compatible we need to convert it to a pipe separated list. This request will replace any new line with a pipe.</p>
            <pre><code>tr '\n' '|'</code></pre>
            <p>The trim command will replace all new lines, which includes the final one at the end of the list. The last action to be taken is the replace method to remove the final entry.</p>
            <pre><code>sed 's/.$//'</code></pre>

            <h4>Abort when no issue is found</h4>
            <p>This step was created to provide information for the next step in the workflow. If no ticket can be found we should mark the step as failed. This is important because we can set the next step to not run when the previous step is not successful.</p>
            <pre><code># If no issue, abort
if [ -z "${JIRA_ISSUE}" ]; then
    echo "Input doesn't contain Jira issue"
    exit -1
fi</code></pre>
            <p>When a step fails, it will mark the entire build as a failure. <a href="https://devcenter.bitrise.io/tips-and-tricks/dont-mark-build-failed-if-step-fails/" target="_blank">We can get around this by marking this step as skippable</a>, this can be done by editing the bitrise.yml file directly:</p>
            <pre><code>- find-jira-issue@0:
    is_skippable: true
    inputs:
        - find_issue_content: "$BITRISE_GIT_MESSAGE"</code></pre>

            <h4>Save environment variable using <em>envman</em></h4>
            <p>Now that we have successfully located the Jira ticket number, we need to tell Bitrise to pass this value to the next step of the workflow. This is done using a command called <a href="https://github.com/bitrise-io/envman/" target="_blank">envman</a> to add the result as an environment variable.</p>
            <pre><code>if command -v envman 2&gt;/dev/null; then
    echo "Adding $JIRA_ISSUE to env. vars"
    envman add --key JIRA_ISSUE --value "${JIRA_ISSUE}"
fi</code></pre>

            <h3>Post Jira Comment Integration</h3>
            <p>I used the Bitrise provided <em>Post Jira Comment</em> workflow step. A link can be found below. I went with this approach because it removed the complication of authorization and formatting the HTTP Post request.</p>
            <figure>
                <img src="img/1_N2KQGHC0EA30lATq7phcRg.png" alt="Post Jira Comment step in Bitrise workflow" />
                <figcaption>Make sure you toggle the box that indicates that this step should not run if the previous step failed.</figcaption>
            </figure>

            <h4>Secrets</h4>
            <p>Jira account username, password/api token, and base url. These are sensitive variables, and should be saved in the Bitrise secrets section so they are not outputted in the public Bitrise log. I would recommend creating a new Jira user for this account with the <a href="https://www.bitrise.io/presskit" target="_blank">appropriate display picture</a>.</p>

            <h4>Jira issue keys</h4>
            <p>This is the environment variable we set in the previous workflow step. I called this $JIRA_ISSUE above.</p>

            <h4>Build Message</h4>
            <p>Identify what is important to the consumers of the comment. Ensure that it is clear, concise, and has easy to identify links to builds. Jira tables don't handle multiple lines, so I also wrapped the commit message in no-format tag to ensure that it displays correctly.</p>
            <pre><code>(/) *$BITRISE_APP_TITLE* build *$BITRISE_BUILD_NUMBER* is now available
||Commit|{noformat}$BITRISE_GIT_MESSAGE{noformat}|
||Branch|$BITRISE_GIT_BRANCH|
||Hash|$GIT_CLONE_COMMIT_HASH|

[Download|$BITRISE_PUBLIC_INSTALL_PAGE_URL] | [Details|$BITRISE_BUILD_URL]</code></pre>
            <figure>
                <img src="img/1_YC98vJMPDxESSWJvmBEFjg.png" alt="The finished Jira comment result" />
                <figcaption>The Finished Result</figcaption>
            </figure>
            <p>Overall this increased the productivity of our team and ensured that my colleagues could be effective with their time. By watching Jira tickets, colleagues would be notified by email when builds would be complete and it also provided a link to the public download page so it was easier for non-technical employees to download builds without navigating the Bitrise details page.</p>
            <p>Hopefully the <em>find-jira-issues</em> workflow step pull request is accepted, because I imagine this will be useful for other teams for all kinds of notifications and reporting.</p>

            <div class="further-reading">
                <h4>Further Reading</h4>
                <ul>
                    <li><a href="https://github.com/bitrise-steplib/steps-post-jira-comment-with-build-details" target="_blank">bitrise-steplib/steps-post-jira-comment-with-build-details</a></li>
                    <li><a href="https://github.com/bitrise-io/bitrise-steplib/pull/2570" target="_blank">find-jira-issue 0.0.1 by jimmithy · Pull Request #2570 · bitrise-io/bitrise-steplib</a></li>
                </ul>
            </div>

            <div class="article-source">
                Originally published on <a href="https://medium.com/@jimmithy/jira-bitrise-updating-tickets-with-new-builds-583861f7a5d5" target="_blank">Medium</a> on June 26, 2020.
            </div>
        </article>
    </section>
</body>

</html>
