<html lang="en">

<head>
    <title>
        James O'Brien - Jira & Bitrise: Comments on New Builds
    </title>
    <link rel="canonical" href="http://www.jamesob.com/apps/brick.html" />
    <meta name="description" content="Jira & Bitrise: Comments on New Builds by James O'Brien" />
    <link rel="icon" type="image/png" sizes="32x32" href="../fav/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../fav/favicon-16x16.png">
    <link rel="manifest" href="../fav/site.webmanifest">
    <link rel="stylesheet" type="text/css" href="../style.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto&display=swap">
    <meta name="viewport" content="width=460" />
    <meta charset="utf-8" />
    <meta name="theme-color" content="#3e98ba">
    <script>
        (function (i, s, o, g, r, a, m) {
            i['GoogleAnalyticsObject'] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o),
                m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m)
        })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

        ga('create', 'UA-70691048-2', 'auto');
        ga('send', 'pageview');
    </script>
</head>

<body>
    <section id="header">
        <div id="headerCenter">
            <a href="../index.html">
                <img id="avatar" src="../img/avatar.png" alt="Home Page" />
            </a>
            <a href="../index.html" id="title">James O'Brien</a>
            <ul class="navigation">
                <li><a href="../index.html">Home</a></li>
                <li><a href="../apps/index.html">Applications</a></li>
                <li><a href="../writings.html">Writings</a></li>
            </ul>
            <div class="social">
                <a href="https://www.linkedin.com/in/jimmithy/" target="_blank" title="linkedin">
                    <svg class="icons" width="20" height="20" viewBox="0 0 1000 1000">
                        <path
                            d="M892,10H108c-53.9,0-98,44.1-98,98v784c0,53.9,44.1,98,98,98h784c53.9,0,98-44.1,98-98V108C990,54.1,945.9,10,892,10z M304,843H157V402h147V843z M230.5,318.7c-49,0-88.2-39.2-88.2-88.2c0-49,39.2-88.2,88.2-88.2c49,0,88.2,39.2,88.2,88.2C318.7,279.5,279.5,318.7,230.5,318.7z M843,843H696V583.3c0-39.2-34.3-73.5-73.5-73.5c-39.2,0-73.5,34.3-73.5,73.5V843H402V402h147v58.8c24.5-39.2,78.4-68.6,122.5-68.6c93.1,0,171.5,78.4,171.5,171.5V843z">
                        </path>
                    </svg>
                </a>
            </div>
        </div>
    </section>
    <section id="content">
        <div class="fullitem">
            <div class="section-inner sectionLayout--insetColumn">
                <h3 name="8ce2" id="8ce2" class="graf graf--h3 graf--leading graf--title">Jira &amp; Bitrise: Comments
                    on New&nbsp;Builds</h3>
                <p name="82e2" id="82e2" class="graf graf--p graf-after--h3">I joined a team this year which has been
                    experimenting with using <a href="http://bitrise.io" data-href="http://bitrise.io"
                        class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Bitrise</a> for <a
                        href="https://en.wikipedia.org/wiki/Continuous_integration"
                        data-href="https://en.wikipedia.org/wiki/Continuous_integration"
                        class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Continuous
                        Integration</a> of Android and iOS builds. I come from a Jenkins background, so it was a great
                    opportunity to learn something new and overall I have been impressed by Bitrise's simple to
                    understand workflow with almost drag and drop components.</p>
                <p name="187b" id="187b" class="graf graf--p graf-after--p">The problems I found was that the team
                    members not working in engineering would often ask the developer for a link to the Bitrise build so
                    they could download and test. The Bitrise job would output multiple files, so there were often
                    questions over which build to use. We were also using the github plugin in Jira, but it was
                    cumbersome to navigate through Jira, github, Bitrise to locate the latest build.</p>
                <p name="27c8" id="27c8" class="graf graf--p graf-after--p">In an attempt to improve this process, I
                    decided to write an addition to our Bitrise workflow which would post a comment on the Jira ticket
                    once the build had completed.</p>
                <h3 name="818d" id="818d" class="graf graf--h3 graf-after--p">Find Jira Tickets&nbsp;Script</h3>
                <p name="3902" id="3902" class="graf graf--p graf-after--h3">The first problem I needed to solve was to
                    figure out the relationship between Bitrise builds and Jira tickets. My workplace typically require
                    that the Jira ticket is included in the commit message and/or the branch name. Fortunately, Bitrise
                    provide these as an environment variables which I can then search for the ticket number.</p>
                <p name="7cf1" id="7cf1" class="graf graf--p graf-after--p">I visited the workflow editor, selected my
                    primary workflow, and added a new step at the end. I was unable to find an existing step that would
                    identify Jira tickets, so I selected the <em class="markup--em markup--p-em">Script</em> step which
                    would let me run my custom bash query.</p>
                <figure name="79a0" id="79a0" class="graf graf--figure graf-after--p"><img class="graf-image"
                        data-image-id="1*Jqj-d7DLAO8XQAT7zUPEcg.png" data-width="894" data-height="474"
                        src="https://cdn-images-1.medium.com/max/800/1*Jqj-d7DLAO8XQAT7zUPEcg.png">
                    <figcaption class="imageCaption">I named it ‘Find Jira Issue’ so it could be easily identified in
                        the&nbsp;workflow</figcaption>
                </figure>
                <h4 name="3729" id="3729" class="graf graf--h4 graf-after--figure">(Update)</h4>
                <p name="4c14" id="4c14" class="graf graf--p graf-after--h4">I submitted this step to Bitrise to include
                    in their catalog of steps, so you can now just select the Find Jira Issue step instead of selecting
                    Script. The step will allow you to set the input and will output a list of unique tickets as <em
                        class="markup--em markup--p-em">$JIRA_ISSUE_LIST</em>.</p>
                <p name="f210" id="f210" class="graf graf--p graf-after--p"><a
                        href="https://www.bitrise.io/integrations/steps/find-jira-issue"
                        data-href="https://www.bitrise.io/integrations/steps/find-jira-issue"
                        class="markup--anchor markup--p-anchor" rel="noopener"
                        target="_blank">https://www.bitrise.io/integrations/steps/find-jira-issue</a></p>
                <h4 name="9c86" id="9c86" class="graf graf--h4 graf-after--p">Searching the commit message for
                    a&nbsp;ticket</h4>
                <pre name="2041" id="2041"
                    class="graf graf--pre graf-after--h4">#!/usr/bin/env bash<br>set -o pipefail</pre>
                <pre name="040c" id="040c"
                    class="graf graf--pre graf-after--pre">echo "Extracting JIRA Issue number from commit message '${BITRISE_GIT_MESSAGE}"</pre>
                <pre name="35e2" id="35e2"
                    class="graf graf--pre graf-after--pre">JIRA_ISSUE="$(echo "${BITRISE_GIT_MESSAGE}" | egrep -o '[a-zA-Z]+-[0-9]+' | sort -uf | tr '\n' '|' | sed 's/.$//')"</pre>
                <h4 name="8c9d" id="8c9d" class="graf graf--h4 graf-after--pre">Breaking down the&nbsp;query</h4>
                <p name="d453" id="d453" class="graf graf--p graf-after--h4">The first step is to select the input. This
                    can be different depending on your process. Some teams use the branch name to identify the ticket,
                    others will add it to the commit message. Bitrise provides environment variables to identify each of
                    these inputs so these can be used in your workflow step. Here is an example of using both the commit
                    message and branch name as the input:</p>
                <pre name="96ff" id="96ff"
                    class="graf graf--pre graf-after--p">echo "${BITRISE_GIT_MESSAGE} ${BITRISE_GIT_BRANCH}"</pre>
                <p name="1cdb" id="1cdb" class="graf graf--p graf-after--pre">Next we search for anything that matches a
                    Jira ticket pattern, this is typically as follows:<br>&nbsp;1. Upper or lower case text which will
                    identify a Jira Project<br>&nbsp;2. Separated by a hyphen&nbsp;<br>&nbsp;3. Ends in a number, which
                    will indicate the ticket id</p>
                <pre name="6b90" id="6b90" class="graf graf--pre graf-after--p">egrep -o '[a-zA-Z]+-[0-9]+'</pre>
                <p name="09c0" id="09c0" class="graf graf--p graf-after--pre">You could add character limits to both the
                    Jira project and ticket number to enforce a specific pattern and reduce false matches, or if you use
                    a single Jira project you can be specific about the name.</p>
                <pre name="4ddc" id="4ddc" class="graf graf--pre graf-after--p">egrep -o 'PROJECT-[0–9]+'</pre>
                <p name="3b35" id="3b35" class="graf graf--p graf-after--pre">To ensure we find unique tickets, you can
                    sort this list with flags specifying that the sorting is case insensitive and the output should
                    remove any duplicates.</p>
                <pre name="71e4" id="71e4" class="graf graf--pre graf-after--p">sort -uf</pre>
                <p name="9551" id="9551" class="graf graf--p graf-after--pre">The search request will output each
                    successful result on new lines and to make this Bitrise compatible we need to convert it to a pipe
                    separated list. This request will replace any new line with a pipe.</p>
                <pre name="183a" id="183a" class="graf graf--pre graf-after--p">tr '\n' '|'</pre>
                <p name="e015" id="e015" class="graf graf--p graf-after--pre">The trim command will replace all new
                    lines, which includes the final one at the end of the list. The last action to be taken is the
                    replace method to remove the final entry.</p>
                <pre name="2569" id="2569" class="graf graf--pre graf-after--p">sed 's/.$//'</pre>
                <h4 name="2fff" id="2fff" class="graf graf--h4 graf-after--pre">Abort when no issue is&nbsp;found</h4>
                <p name="3f63" id="3f63" class="graf graf--p graf-after--h4">This step was created to provide
                    information for the next step in the workflow. If no ticket can be found we should mark the step as
                    failed. This is important because we can set the next step to not run when the previous step is not
                    successful.</p>
                <pre name="de2c" id="de2c"
                    class="graf graf--pre graf-after--p"># If no issue, abort<br>if [ -z "${JIRA_ISSUE}" ]; then<br>    echo "Input doesn't contain Jira issue"<br>    exit -1<br>fi</pre>
                <p name="fdca" id="fdca" class="graf graf--p graf-after--pre">When a step fails, it will mark the entire
                    build as a failure. <a
                        href="https://devcenter.bitrise.io/tips-and-tricks/dont-mark-build-failed-if-step-fails/"
                        data-href="https://devcenter.bitrise.io/tips-and-tricks/dont-mark-build-failed-if-step-fails/"
                        class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">We can get around this by
                        marking this step as skippable</a>, this can be done by editing the bitrise.yml file directly:
                </p>
                <pre name="bb77" id="bb77"
                    class="graf graf--pre graf-after--p">- find-jira-issue@0:<br>    is_skippable: true<br>    inputs: <br>        - find_issue_content: "$BITRISE_GIT_MESSAGE"</pre>
                <h4 name="9b01" id="9b01" class="graf graf--h4 graf-after--pre">Save environment variable using&nbsp;<em
                        class="markup--em markup--h4-em">envman</em></h4>
                <p name="ffd9" id="ffd9" class="graf graf--p graf-after--h4">Now that we have successfully located the
                    Jira ticket number, we need to tell Bitrise to pass this value to the next step of the workflow.
                    This is done using a command called <a href="https://github.com/bitrise-io/envman/"
                        data-href="https://github.com/bitrise-io/envman/" class="markup--anchor markup--p-anchor"
                        rel="noopener" target="_blank">envman</a> to add the result as an environment variable.</p>
                <pre name="6938" id="6938"
                    class="graf graf--pre graf-after--p">if command -v envman 2&gt;/dev/null; then<br>    echo "Adding $JIRA_ISSUE to env. vars"<br>    envman add --key JIRA_ISSUE --value "${JIRA_ISSUE}"<br>fi</pre>
                <h3 name="6de5" id="6de5" class="graf graf--h3 graf-after--pre">Post Jira Comment Integration</h3>
                <p name="01a1" id="01a1" class="graf graf--p graf-after--h3">I used the Bitrise provided <em
                        class="markup--em markup--p-em">Post Jira Comment </em>workflow step. A link can be found below.
                    I went with this approach because it removed the complication of authorization and formatting the
                    HTTP Post request.</p>
                <figure name="204d" id="204d" class="graf graf--figure graf-after--p"><img class="graf-image"
                        data-image-id="1*N2KQGHC0EA30lATq7phcRg.png" data-width="584" data-height="280"
                        src="https://cdn-images-1.medium.com/max/800/1*N2KQGHC0EA30lATq7phcRg.png">
                    <figcaption class="imageCaption">Make sure you toggle the box that indicates that this step should
                        not run if the previous step&nbsp;failed.</figcaption>
                </figure>
                <h4 name="00f6" id="00f6" class="graf graf--h4 graf-after--figure">Secrets</h4>
                <p name="e729" id="e729" class="graf graf--p graf-after--h4">Jira account username, password/api token,
                    and base url. These are sensitive variables, and should be saved in the Bitrise secrets section so
                    they are not outputted in the public Bitrise log. I would recommend creating a new Jira user for
                    this account with the <a href="https://www.bitrise.io/presskit"
                        data-href="https://www.bitrise.io/presskit" class="markup--anchor markup--p-anchor"
                        rel="noopener" target="_blank">appropriate display picture</a>.</p>
                <h4 name="5d0f" id="5d0f" class="graf graf--h4 graf-after--p">Jira issue&nbsp;keys</h4>
                <p name="5669" id="5669" class="graf graf--p graf-after--h4">This is the environment variable we set in
                    the previous workflow step. I called this $JIRA_ISSUE above.</p>
                <h4 name="8970" id="8970" class="graf graf--h4 graf-after--p">Build Message</h4>
                <p name="b2da" id="b2da" class="graf graf--p graf-after--h4">Identify what is important to the consumers
                    of the comment. Ensure that it is clear, concise, and has easy to identify links to builds. Jira
                    tables don’t handle multiple lines, so I also wrapped the commit message in no-format tag to ensure
                    that it displays correctly.</p>
                <pre name="c641" id="c641"
                    class="graf graf--pre graf-after--p">(/) *$BITRISE_APP_TITLE* build *$BITRISE_BUILD_NUMBER* is now available<br>||Commit|{noformat}$BITRISE_GIT_MESSAGE{noformat}|<br>||Branch|$BITRISE_GIT_BRANCH|<br>||Hash|$GIT_CLONE_COMMIT_HASH|</pre>
                <pre name="f7bf" id="f7bf"
                    class="graf graf--pre graf-after--pre">[Download|$BITRISE_PUBLIC_INSTALL_PAGE_URL] | [Details|$BITRISE_BUILD_URL]</pre>
                <figure name="5395" id="5395" class="graf graf--figure graf-after--pre"><img class="graf-image"
                        data-image-id="1*YC98vJMPDxESSWJvmBEFjg.png" data-width="434" data-height="218"
                        data-is-featured="true"
                        src="https://cdn-images-1.medium.com/max/800/1*YC98vJMPDxESSWJvmBEFjg.png">
                    <figcaption class="imageCaption">The Finished&nbsp;Result</figcaption>
                </figure>
                <p name="2d7c" id="2d7c" class="graf graf--p graf-after--figure">Overall this increased the productivity
                    of our team and ensured that my colleagues could be effective with their time. By watching Jira
                    tickets, colleagues would be notified by email when builds would be complete and it also provided a
                    link to the public download page so it was easier for non-technical employees to download builds
                    without navigating the Bitrise details page.</p>
                <p name="5ff1" id="5ff1" class="graf graf--p graf-after--p graf--trailing">Hopefully the <em
                        class="markup--em markup--p-em">find-jira-issues </em>workflow step<em
                        class="markup--em markup--p-em"> </em>pull request is accepted, because I imagine this will be
                    useful for other teams for all kinds of notifications and reporting.</p>
            </div>
        </div>
        <hr>
        <div class="section-content">
            <div class="section-inner sectionLayout--insetColumn">
                <div name="2dd6" id="2dd6" class="graf graf--mixtapeEmbed graf--leading"><a
                        href="https://github.com/bitrise-steplib/steps-post-jira-comment-with-build-details"
                        data-href="https://github.com/bitrise-steplib/steps-post-jira-comment-with-build-details"
                        class="markup--anchor markup--mixtapeEmbed-anchor"
                        title="https://github.com/bitrise-steplib/steps-post-jira-comment-with-build-details"><strong
                            class="markup--strong markup--mixtapeEmbed-strong">bitrise-steplib/steps-post-jira-comment-with-build-details</strong><br><em
                            class="markup--em markup--mixtapeEmbed-em">Post comment to an issue on Jira Can be run
                            directly with the bitrise CLI, just git clone this repository, cd into
                            it's…</em>github.com</a><a
                        href="https://github.com/bitrise-steplib/steps-post-jira-comment-with-build-details"
                        class="js-mixtapeImage mixtapeImage u-ignoreBlock"
                        data-media-id="ef189e06ca7ac24e86b8ab992ac36bf7" data-thumbnail-img-id="0*VL5zAfItxNpag2_D"
                        style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*VL5zAfItxNpag2_D);"></a>
                </div>
                <div name="4721" id="4721" class="graf graf--mixtapeEmbed graf-after--mixtapeEmbed graf--trailing"><a
                        href="https://github.com/bitrise-io/bitrise-steplib/pull/2570"
                        data-href="https://github.com/bitrise-io/bitrise-steplib/pull/2570"
                        class="markup--anchor markup--mixtapeEmbed-anchor"
                        title="https://github.com/bitrise-io/bitrise-steplib/pull/2570"><strong
                            class="markup--strong markup--mixtapeEmbed-strong">find-jira-issue 0.0.1 by jimmithy · Pull
                            Request #2570 · bitrise-io/bitrise-steplib</strong><br><em
                            class="markup--em markup--mixtapeEmbed-em">What to do if the build fails? At the moment
                            contributors do not have access to the CI workflow triggered by
                            StepLib…</em>github.com</a><a href="https://github.com/bitrise-io/bitrise-steplib/pull/2570"
                        class="js-mixtapeImage mixtapeImage u-ignoreBlock"
                        data-media-id="91339aeef1cdcf61ae584b2849219b53" data-thumbnail-img-id="0*YBdKTgwZFI-in_mh"
                        style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*YBdKTgwZFI-in_mh);"></a>
                </div>
            </div>
        </div>
    </section>
</body>

</html>